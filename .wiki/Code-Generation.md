# Code Generation

## Overview

EJECS generates Luau code optimized for Roblox and Lune environments, with a focus on type safety and performance.

## Command Line Usage

The EJECS compiler can be used as a command-line tool:

```bash
ejecs -input <input-file> -output <output-file> -target luau [-module <module-path>]
```

### Parameters
- `-input`: Path to the input .ejecs file
- `-output`: Path for the generated Luau code
- `-target`: Set to "luau" for Roblox/Lune output
- `-module`: (Optional) Module path for imports

## API Usage

EJECS can be embedded directly in Luau code:

```lua
local EJECS = require("ejecs")

-- Parse EJECS definitions
local world = EJECS.parse([[
    component Transform {
        Vector3 position;
        CFrame orientation;
    }
]])

-- Generate Luau code
local code = EJECS.generate(world, {
    target = "luau",
    module = "game.Components",
    strict = true
})
```

## Generated Code Structure

### Component Types

```lua
--!strict
-- Generated by EJECS

export type Transform = {
    position: Vector3,
    orientation: CFrame
}

export type RigidBody = {
    velocity: Vector3,
    mass: number,
    isKinematic: boolean
}
```

### Component Runtime

```lua
local Components = {
    Transform = {
        name = "Transform",
        new = function(): Transform
            return {
                position = Vector3.new(0, 0, 0),
                orientation = CFrame.new()
            }
        end,
        validate = function(data: any): boolean
            return typeof(data.position) == "Vector3" and
                   typeof(data.orientation) == "CFrame"
        end
    }
}
```

### System Implementation

```lua
--!strict
local Types = require(script.Parent.Types)

local PhysicsSystem = {
    name = "Physics",
    priority = 100,
    frequency = 60,
    
    query = {"Transform", "RigidBody"},
    
    update = function(world, params)
        for _, entity in world:query(PhysicsSystem.query) do
            local transform: Types.Transform = entity.Transform
            local body: Types.RigidBody = entity.RigidBody
            
            body.velocity = body.velocity + params.gravity * params.deltaTime
            transform.position = transform.position + body.velocity * params.deltaTime
        end
    end
}

return PhysicsSystem
```

## Type Mapping

| EJECS Type | Luau Type | Default Value |
|------------|-----------|---------------|
| number     | number    | 0            |
| string     | string    | ""           |
| boolean    | boolean   | false        |
| int        | number    | 0            |
| Vector3    | Vector3   | Vector3.new()|
| CFrame     | CFrame    | CFrame.new() |
| Instance   | Instance  | nil          |
| T[]        | {T}      | {}           |
| {[K]: V}   | {[K]: V} | {}           |

## Integration

### Roblox Services
```lua
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Components = require(ReplicatedStorage.Components)
local Systems = require(ReplicatedStorage.Systems)

-- Create world
local world = ECS.World.new()

-- Register components
for name, component in pairs(Components) do
    world:registerComponent(name, component)
end

-- Register systems
for _, system in ipairs(Systems) do
    world:addSystem(system)
end
```

### Lune Scripts
```lua
local EJECS = require("ejecs")
local fs = require("@lune/fs")

-- Load EJECS definitions
local source = fs.readFile("components.ejecs")
local world = EJECS.parse(source)

-- Generate Luau code
local code = EJECS.generate(world, {
    target = "luau",
    module = "game.Components"
})

-- Write output
fs.writeFile("out/Components.lua", code)
```

## Best Practices

1. **Type Safety**
   - Enable strict type checking
   - Use specific Roblox types
   - Validate component data

2. **Performance**
   - Profile system queries
   - Optimize component access
   - Use appropriate data structures

3. **Organization**
   - Separate components and systems
   - Use consistent module structure
   - Follow Roblox conventions

4. **Maintenance**
   - Version control EJECS files
   - Document type dependencies
   - Keep generated code up to date 